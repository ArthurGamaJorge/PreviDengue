name: Atualiza√ß√£o Semanal dos Dados de Dengue

on:
  schedule: # Ter√ßa feira, √†s quatro da manh√£ (BRT)
    - cron: '0 7 * * 2'
  workflow_dispatch:

jobs:
  update-data-pipeline:
    runs-on: ubuntu-latest
    permissions:
      contents: write 
      id-token: write

    steps:
      - name: Checkout do reposit√≥rio
        uses: actions/checkout@v4

      - name: Setup do Python 3.12
        uses: actions/setup-python@v5
        with:
          python-version: '3.12'

      - name: Instala√ß√£o das depend√™ncias
        working-directory: ./ai_predict/data/pipeline_scripts
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
          pip install huggingface_hub

      - name: Download dos dados clim√°ticos existentes
        env:
          HF_TOKEN: ${{ secrets.HF_TOKEN }}
        run: |
          huggingface-cli download \
            previdengue/predict_climate_data \
            dadosClimaticos.parquet \
            --repo-type dataset \
            --local-dir ./ai_predict/data/

      - name: Executa o pipeline de atualiza√ß√£o de dados
        working-directory: ./ai_predict/data/pipeline_scripts
        run: python master_update.py

      - name: Upload dos dados clim√°ticos atualizados para o Hugging Face
        env:
          HF_TOKEN: ${{ secrets.HF_TOKEN }}
        run: |
          python -c "
          from huggingface_hub import HfApi
          import os
          api = HfApi(token=os.environ['HF_TOKEN'])
          api.upload_file(
              path_or_fileobj='./ai_predict/data/dadosClimaticos.parquet',
              path_in_repo='dadosClimaticos.parquet',
              repo_id='previdengue/predict_climate_data',
              repo_type='dataset',
              commit_message='chore(data): ü§ñ Atualiza√ß√£o semanal autom√°tica dos dados clim√°ticos'
          )"

      - name: Upload dos dados de infer√™ncia para o Hugging Face Hub
        env:
          HF_TOKEN: ${{ secrets.HF_TOKEN }}
        run: |
          python -c "
          from huggingface_hub import HfApi
          import os
          api = HfApi(token=os.environ['HF_TOKEN'])
          api.upload_file(
              path_or_fileobj='./ai_predict/data/inference_data.parquet',
              path_in_repo='inference_data.parquet',
              repo_id='previdengue/predict_inference_data',
              repo_type='dataset',
              commit_message='chore(data): ‚ú® Atualiza√ß√£o semanal autom√°tica dos dados de infer√™ncia'
          )"

      - name: Upload dos dados estaduais de infer√™ncia para o Hugging Face Hub
        env:
          HF_TOKEN: ${{ secrets.HF_TOKEN }}
        run: |
          python -c "
          from huggingface_hub import HfApi
          import os
          api = HfApi(token=os.environ['HF_TOKEN'])
          api.upload_file(
              path_or_fileobj='./ai_predict/data/inference_data_estadual.parquet',
              path_in_repo='inference_data_estadual.parquet',
              repo_id='previdengue/predict_inference_data_estadual',
              repo_type='dataset',
              commit_message='chore(data): üèõÔ∏è Atualiza√ß√£o semanal autom√°tica dos dados estaduais de infer√™ncia'
          )"
